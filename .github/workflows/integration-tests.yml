name: Integration Tests

on:
  push:
    branches:
      - "**"

env:
  NODE_VERSION: "20"

jobs:
  dependencies:
    name: install dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: cache node_modules
        uses: actions/cache@v4
        id: bun-cache
        with:
          path: |
            node_modules
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: install dependencies
        if: steps.bun-cache.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile

  lapikit-vitest:
    name: lapikit vitest
    needs:
      - dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-node_modules

      - name: Install dependencies if cache miss
        run: bun install --frozen-lockfile

      - name: test lapikit with vitest
        run: bun --cwd packages/lapikit test

  lapikit-lint:
    name: lapikit lint
    needs:
      - lapikit-vitest
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-node_modules

      - name: Install dependencies if cache miss
        run: bun install --frozen-lockfile

      - name: linter on lapikit
        run: bun --cwd packages/lapikit lint

  lapikit-build:
    name: build lapikit
    needs:
      - lapikit-lint
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-node_modules

      - name: Install dependencies if cache miss
        run: bun install --frozen-lockfile

      - name: debug before build
        run: |
          echo "=== Checking workspace ==="
          ls -la packages/lapikit/
          echo "=== Checking node_modules ==="
          ls -la node_modules/ | head -5
          echo "=== Checking bun version ==="
          bun --version

      - name: build
        run: |
          echo "=== Installing lapikit dependencies ==="
          cd packages/lapikit
          bun install
          echo "=== Running lapikit build ==="
          bun run build

      - name: verify lapikit build
        run: |
          if [ -d "packages/lapikit/dist/" ]; then
            ls -la packages/lapikit/dist/
            echo "Build files found:"
            find packages/lapikit/dist/ -type f | head -10
          else
            echo "ERROR: dist/ directory not found!"
            echo "Contents of packages/lapikit/:"
            ls -la packages/lapikit/
            exit 1
          fi

      - name: upload lapikit build
        uses: actions/upload-artifact@v4
        with:
          name: lapikit-dist
          path: packages/lapikit/dist/

  site-kit-vitest:
    name: site-kit vitest
    needs:
      - dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-node_modules

      - name: Install dependencies if cache miss
        run: bun install --frozen-lockfile

      - name: test site-kit with vitest
        run: bun --cwd packages/site-kit test

  site-kit-lint:
    name: site-kit lint
    needs:
      - site-kit-vitest
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-node_modules

      - name: Install dependencies if cache miss
        run: bun install --frozen-lockfile

      - name: linter on site-kit
        run: bun --cwd packages/site-kit lint

  site-kit-build:
    name: site-kit build
    needs:
      - site-kit-lint
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-node_modules

      - name: Install dependencies if cache miss
        run: bun install --frozen-lockfile

      - name: debug before build
        run: |
          echo "=== Checking workspace ==="
          ls -la packages/site-kit/
          echo "=== Checking node_modules ==="
          ls -la node_modules/ | head -5
          echo "=== Checking bun version ==="
          bun --version

      - name: build
        run: |
          echo "=== Installing site-kit dependencies ==="
          cd packages/site-kit
          bun install
          echo "=== Running site-kit build ==="
          bun run build

      - name: verify site-kit build
        run: |
          if [ -d "packages/site-kit/dist/" ]; then
            ls -la packages/site-kit/dist/
            echo "Build files found:"
            find packages/site-kit/dist/ -type f | head -10
          else
            echo "ERROR: dist/ directory not found!"
            echo "Contents of packages/site-kit/:"
            ls -la packages/site-kit/
            exit 1
          fi

      - name: Upload Site-Kit Build
        uses: actions/upload-artifact@v4
        with:
          name: site-kit-dist
          path: packages/site-kit/dist/

  website:
    name: build lapikit.dev
    runs-on: ubuntu-latest
    needs:
      - lapikit-build
      - site-kit-build
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1.2.2

      - name: restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-node_modules

      - name: Install dependencies if cache miss
        run: bun install --frozen-lockfile

      - name: download lapikit build
        uses: actions/download-artifact@v4
        with:
          name: lapikit-dist
          path: packages/lapikit/dist/

      - name: download site-kit build
        uses: actions/download-artifact@v4
        with:
          name: site-kit-dist
          path: packages/site-kit/dist/

      - name: create .env file
        run: |
          cd apps/website
          echo "PUBLIC_ENV=development" >> .env
          echo "PUBLIC_BASE_URL=http://localhost:5173" >> .env
          echo "PUBLIC_API=true" >> .env
          echo "PUBLIC_GOOGLE_ANALYTICS_ENABLED=true" >> .env
          echo "PUBLIC_GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX" >> .env
          echo "PUBLIC_GOOGLE_TAG_MANAGER_ENABLED=true" >> .env
          echo "PUBLIC_GOOGLE_TAG_MANAGER_ID=GTM-XXXXXX" >> .env
          echo "PUBLIC_BING_WEBMASTER_TOOLS_ENABLED=true" >> .env
          echo "PUBLIC_BING_WEBMASTER_TOOLS_ID=XXXXXXXXXX" >> .env

      - name: build
        run: cd apps/website && bun initialize && bun run build

  deploy-to-vps-alpha:
    name: deploy [ALPHA] lapikit.dev
    needs: website
    if: github.ref != 'refs/heads/main'
    uses: ./.github/workflows/ci-alpha.yml
    secrets: inherit

  deploy-to-vps-prod:
    name: deploy [PROD] lapikit.dev
    needs: website
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/ci.yml
    secrets: inherit
